<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
      <!--
		
		Generated at 2007-02-12T11:38:49.726Z-->
      <title>Saxonica: XSLT and XQuery Processing: Serial Processing for Large Documents</title>
      <meta name="coverage" content="Worldwide">
      <meta name="copyright" content="Copyright Saxonica Ltd">
      <meta name="title" content="Saxonica: XSLT and XQuery Processing: Serial Processing for Large Documents">
      <meta name="robots" content="noindex,nofollow">
      <link rel="stylesheet" href="../../saxondocs.css" type="text/css">
   </head>
   <body class="main">
      <div id="rhDkBlueArea" style="position:absolute; width:123px; height:1424px; z-index:2; right: 0px; top: 0px; border: 1px none #000000; background-color: #C1CEDE; layer-background-color: #C1CEDE; visibility: visible;"></div>
      <div id="rhMdBlueArea" style="position:absolute; width:217px; height:1424px; z-index:2; right: 340px; top: 0px; border: 1px none #000000; background-color: #E4EEF0; layer-background-color: #E4EEF0; visibility: visible;"></div>
      <div id="lhLightArea" style="position:absolute; width:34px; height:1424px; z-index:2; left: 66px; top: 0px; border: 1px none #000000; background-color: #f6fffb; layer-background-color: #E4EEF0; visibility: visible;"></div>
      <div id="lhDkBlueArea" style="position:absolute; width:66px; height:1424px; z-index:2; left: 0px; top: 0px; border: 1px none #000000; background-color: #C1CEDE; layer-background-color: #C1CEDE; visibility: visible;"></div>
      <div id="LogoArea" style="position:absolute; width:340px; height:72px; z-index:3; right: 0px; top: 0px; border: 1px none #000000; visibility: visible;"><a href="../../index/intro.html"><img src="../../img/saxonica_logo.gif" width="340" height="72" border="0" alt="Saxonica.com"></a></div>
      <div id="MenuArea" style="position:absolute; width:157px; z-index:4; right: 33px; top: 114px; visibility: visible; background-color: #f6fffb; layer-background-color: #f6fffb; border: 1px solid #3D5B96; padding-top:9px; padding-left:15px;padding-right:11px; padding-bottom:9px;">
         <table width="164" border="0" bgcolor="#3D5B96" cellspacing="1" cellpadding="1">
            <tr bgcolor="#f6fffb">
               <td style="padding-left:5px"><a href="http://www.saxonica.com/">SAXONICA</a></td>
            </tr>
         </table><br><table border="0" cellspacing="0" cellpadding="1">
            <tr>
               <td class="title" colspan="2">Saxon Documentation</td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/spacer.gif" width="120" height="10" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../contents.html">Full Contents</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../index/intro.html">About Saxon</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../changes/intro.html">Changes in this Release</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro.html">Version 8.9 (2007-02-12)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro88.html">Version 8.8 (2006-09-05)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro873.html">Version 8.7.3 (2006-06-13)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v872.html">Version 8.7.2 (2006-04-19)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v871.html">Version 8.7.1 (2006-04-13)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro87.html">Version 8.7 (2006-02-24)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro861.html">Version 8.6.1 (24 November 2005)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro86.html">Version 8.6 (3 November 2005)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro851.html">Version 8.5.1 (26 August 2005)</a></td>
            </tr>
            <tr>
               <td>»&nbsp;</td>
               <td><a href="../intro85.html">Version 8.5 (2 August 2005)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v84.html">Version 8.4 (4 April 2005)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v83.html">Version 8.3 (11 February 2005)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v8.2.html">Version 8.2 (21 December 2004)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v811.html">Version 8.1.1 (8 October 2004)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../intro81.html">Version 8.1 (24 September 2004)</a></td>
            </tr>
            <tr>
               <td><img src="../../img/spacer.gif" width="10" height="5" border="0" alt="blank space"></td>
               <td><a href="../v8.0.html">Version 8.0 (1 June 2004)</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../conditions/intro.html">Conditions of Use</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../using-xsl/intro.html">Using XSLT 2.0</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../using-xquery/intro.html">Using XQuery</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../sourcedocs/intro.html">Handling Source Documents</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../schema-processing/intro.html">XML Schema Processing</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../xpath-api/intro.html">XPath API for Java</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../dotnet/intro.html">Saxon on .NET</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../extensibility/intro.html">Extensibility</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../extensions/intro.html">Saxon Extensions</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../samples/intro.html">Sample Saxon Applications</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../sql-extension/intro.html">The Saxon SQL Extension</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../xsl-elements/intro.html">XSLT Elements</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../expressions/intro.html">XPath 2.0 Expression Syntax</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../functions/intro.html">Function Library</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
            <tr>
               <td colspan="2"><a href="../../conformance/intro.html">Standards Conformance</a></td>
            </tr>
            <tr>
               <td colspan="2"><img src="../../img/text_blue_dot.gif" width="164" height="1" border="0" alt=""></td>
            </tr>
         </table>
      </div>
      <div id="MainTextArea" style="position:absolute; height:100%; z-index:5; left: 130px; right: 260px; top: 110px; border: 1px none #000000; visibility: visible;">
         <h1>Serial Processing for Large Documents</h1>
         <p>Saxon 8.5 introduces a new optimization, specifically designed for processing of large
            documents, where the need to allocate sufficient memory to hold the entire source tree is
            traditionally a problem.
         </p>
         <p>This currently works only in XSLT, and is supported only in Saxon-SA (though the stylesheet
            does not need to be schema-aware). It involves no new language constructs, but needs to be enabled
            by means of the extension attribute <code>saxon:read-once="yes"</code>. It is invoked by
            a stereotypical coding pattern that the optimizer recognizes and treats specially.
         </p>
         <p>The typical code is as follows:</p>
         <div class="codeblock" style="border: solid thin; background-color: #B1CCC7; padding: 2px"><pre><code>
&lt;xsl:function name="f:customers"&gt;
 &lt;xsl:copy-of select="doc('customers.xml')/*/customer"
       saxon:read-once="yes" xmlns:saxon="http://saxon.sf.net/"/&gt;
&lt;/xsl:function&gt;

&lt;xsl:template name="main"&gt;
  &lt;xsl:apply-templates select="f:customers()"/&gt;
&lt;/xsl:template&gt;
</code></pre></div>
         <p>It's not necessary for such a stylesheet to have a principal source document, the transformation
            can be invoked instead using the <code>-it main</code> option from the command line, or its equivalent
            in the Java API.
         </p>
         <p>The important factors here are:</p>
         <ul>
            <li>
               <p>The <code>xsl:copy-of</code> instruction must be used, with a select expression that starts
                  with a call on the <code>document()</code> or <code>doc()</code> function. The significance of this is
                  that because the instruction is making a copy of the nodes in the external document, there is no requirement
                  that the nodes returned by multiple attempts to access the same document should have the same identity.
                  Saxon therefore doesn't need to include the source document in its in-memory document pool.
                  (The "copy" is purely notional of course, since the original source tree corresponding to the
                  <code>customers.xml</code> document is never materialized.)
               </p>
            </li>
            <li>
               <p>The path expression introduced by the call on <code>document()</code> or <code>doc</code> must conform
                  to the rules for path expressions appearing in identity constraints in XML Schema. This means there must be
                  no predicates; the first step (but only the first) can be introduced with "//"; the last step can optionally
                  use the attribute axis; all other steps must be simple Axis Steps using the child axis. These restrictions allow
                  Saxon to use the same code for serial XPath processing that is already used for validating identity constraints
                  against a schema (which is one reason the facility is available only in Saxon-SA).
               </p>
            </li>
            <li>
               <p>It is not absolutely essential that the <code>xsl:copy-of</code> instruction is used within a function,
                  but this is the easiest way of ensuring that the instruction is executed in pull mode, which is a prerequisite
                  for this optimization to be activated.
               </p>
            </li>
            <li>
               <p>The optimization is enabled only if the <code>saxon:read-once</code> attribute is present and is
                  set to "yes", and if the stylesheet is processed using Saxon-SA.
               </p>
            </li>
            <li>
               <p>The optimization should not be enabled if the source document is read more than once in the course
                  of the transformation. There are two reasons for this: firstly, performance will be better in this case if the
                  document is read into memory; and secondly, when this optimization is used, there is no guarantee that the
                  <code>document()</code> function will be stable, that is, that it will return the same results when called
                  repeatedly with the same URI.
               </p>
            </li>
         </ul>
         <p>The implementation of this facility uses multithreading. One thread (which operates as a push pipeline)
            is used to read the source document and filter out the nodes selected by the path expression. The nodes are then
            handed over to the main processing thread, which iterates over the selected nodes using an XPath pull pipeline.
            Because multithreading is used, this facility is not used when tracing is enabled. It should also be disabled
            when using a debugger (there is a method in the Configuration object to achieve this.)
         </p>
         <p>Note that a tree is built for each selected node, and its subtree. The saving in memory comes when these nodes
            are processed one at a time, because each subtree can then be discarded as soon as it has been processed. There
            is no benefit if the stylesheet needs to perform non-serial processing, such as sorting. There is also no benefit
            if the path expression selects a node that contains most or all of the source document, for example its outermost
            element.
         </p>
         <p>Saxon can handle expressions that select nested nodes, for example <code>//section</code> where one section
            contains another. However, the need to deliver nodes in document order makes the pipeline somewhat turbulent
            in such cases, increasing memory usage.
         </p>
         <p>Serial processing in this way is not actually faster than conventional processing (in fact,
            it may only run at half the speed). Its big advantage is that it saves memory, thus making it possible to
            process documents that would otherwise be too large for XSLT to handle. There may also be environments
            where the multithreading enables greater use of the processor capacity available.
            To run without this optimization,
            either change the <code>xsl:copy-of</code> instruction to <code>xsl:sequence</code>,
            or set <code>saxon:read-once</code> to "no".
         </p>
         <table width="100%">
            <tr>
               <td>
                  <p align="right"><a class="nav" href="schema85.html">Next</a></p>
               </td>
            </tr>
         </table>
      </div>
   </body>
</html>